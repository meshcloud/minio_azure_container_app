# Custom ModSecurity logging configuration for Azure Log Analytics
# Include base ModSecurity configuration
Include /etc/modsecurity.d/modsecurity.conf

# Override audit logging to send to stdout (captured by Azure Container Logs)
SecAuditEngine RelevantOnly
SecAuditLog /dev/stdout
SecAuditLogFormat JSON
SecAuditLogType Serial

# Custom logging format for better parsing in Log Analytics
SecAuditLogParts ABCFHZ

# Log blocked requests with structured format
LogFormat '{"timestamp":"%{%Y-%m-%dT%H:%M:%S}t","client_ip":"%a","method":"%m","uri":"%U","status":"%>s","user_agent":"%{User-Agent}i","referer":"%{Referer}i","modsec_messages":"%{MODSEC_MESSAGES}e"}' modsec_json

# Enable rule engine
SecRuleEngine On

# Load OWASP CRS rules
Include /opt/owasp-crs/crs-setup.conf
Include /opt/owasp-crs/rules/*.conf

# Custom rules for MinIO/S3 compatibility
SecRule REQUEST_METHOD "@streq PUT" \
    "id:1001,phase:1,pass,msg:'Allow S3 PUT operations',tag:'s3-api',logdata:'S3 PUT allowed for %{REQUEST_URI}'"

SecRule REQUEST_METHOD "@streq DELETE" \
    "id:1002,phase:1,pass,msg:'Allow S3 DELETE operations',tag:'s3-api',logdata:'S3 DELETE allowed for %{REQUEST_URI}'"

SecRule REQUEST_HEADERS:Authorization "@rx ^AWS4-HMAC-SHA256" \
    "id:1003,phase:1,pass,msg:'Allow AWS4 signature',tag:'s3-api'"

# Exclusions for false positives with S3 operations
SecRuleUpdateTargetById 942100 "!REQUEST_BODY"
SecRuleUpdateTargetById 942110 "!REQUEST_BODY"
SecRuleUpdateTargetById 941100 "!REQUEST_BODY"
SecRuleUpdateTargetById 941110 "!REQUEST_BODY"